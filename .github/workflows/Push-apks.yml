name: Sync FongMi APK & Push Telegram (Stable)

on:
  schedule:
    - cron: "0 */6 * * *" # 每 6 小时
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout 仓库
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 安装依赖
        run: |
          sudo apt-get update
          sudo apt-get install -y unzip jq coreutils opencc

      - name: 下载 FongMi fongmi 分支 ZIP
        run: |
          curl -L -o fongmi.zip https://codeload.github.com/FongMi/Release/zip/refs/heads/fongmi
          unzip -q fongmi.zip

      - name: 收集 APK
        run: |
          mkdir -p apk
          find Release-fongmi/apk -type f -name "*.apk" -exec cp {} apk/ \;
          echo "已收集 APK："
          ls -lh apk/

      - name: 解析 JSON + 合并日志（简体 + 北京时间）
        run: |
          curl -s -o leanback.json https://raw.githubusercontent.com/FongMi/Release/fongmi/apk/leanback.json
          curl -s -o mobile.json   https://raw.githubusercontent.com/FongMi/Release/fongmi/apk/mobile.json

          version=$(jq -r '.name // "未知版本"' leanback.json)

          # 合并 desc → 去重
          jq -r '.desc[]?' leanback.json mobile.json \
            | sed 's/^[*•-]\s*//' \
            | sort -u > logs_raw.txt

          # 繁体转简体
          opencc -i logs_raw.txt -o logs_cn.txt -c t2s.json

          # 加 •
          logs=$(sed 's/^/• /' logs_cn.txt)

          update_time=$(TZ=Asia/Shanghai date '+%Y/%m/%d %H:%M')

          caption=$(cat <<EOF
- 影视 · 蜂蜜版

- 本次更新：
$logs

当前版本：$version
更新时间：$update_time
EOF
)

          echo "caption<<EOF" >> $GITHUB_ENV
          echo "$caption" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

          echo "====== Telegram Caption ======"
          echo "$caption"

      - name: 计算 APK hash
        id: hash
        run: |
          hash=$(find apk -type f -name "*.apk" -print0 \
            | sort -z \
            | xargs -0 sha256sum \
            | sha256sum | cut -d' ' -f1)
          echo "hash=$hash" >> $GITHUB_OUTPUT

      - name: 读取上次 hash
        id: last
        run: |
          last=$(cat last_hash.txt 2>/dev/null || echo "")
          echo "last=$last" >> $GITHUB_OUTPUT

      - name: 判断是否变化
        id: check
        run: |
          if [ "${{ steps.hash.outputs.hash }}" = "${{ steps.last.outputs.last }}" ]; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: 无变化则退出
        if: steps.check.outputs.changed == 'false'
        run: exit 0

      - name: 保存新 hash
        run: |
          echo "${{ steps.hash.outputs.hash }}" > last_hash.txt
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add last_hash.txt
          git commit -m "chore: update last_hash" || true
          git push

      - name: 创建 Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          tag="auto-$(date +'%Y%m%d-%H%M')"
          git tag "$tag" || true
          git push origin "$tag"

          gh release create "$tag" apk/*.apk \
            --title "FongMi APK $tag" \
            --notes "自动同步自：https://github.com/FongMi/Release/tree/fongmi/apk"

      - name: 推送 Telegram（4 APK + 日志同一条）
        env:
          BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
          CHAT_ID: ${{ secrets.CHAT_ID }}
          BOT_API_BASE: https://prominent-tootsie-apkrelease-1850e28f.koyeb.app
        run: |
          media=$(jq -nc --arg caption "$caption" '[
            {"type":"document","media":"attach://leanback-arm64_v8a.apk"},
            {"type":"document","media":"attach://leanback-armeabi_v7a.apk"},
            {"type":"document","media":"attach://mobile-arm64_v8a.apk"},
            {
              "type":"document",
              "media":"attach://mobile-armeabi_v7a.apk",
              "caption": $caption
            }
          ]')

          response=$(curl -s -X POST "$BOT_API_BASE/bot$BOT_TOKEN/sendMediaGroup" \
            -F chat_id="$CHAT_ID" \
            -F media="$media" \
            -F "leanback-arm64_v8a.apk=@apk/leanback-arm64_v8a.apk" \
            -F "leanback-armeabi_v7a.apk=@apk/leanback-armeabi_v7a.apk" \
            -F "mobile-arm64_v8a.apk=@apk/mobile-arm64_v8a.apk" \
            -F "mobile-armeabi_v7a.apk=@apk/mobile-armeabi_v7a.apk"
          )

          echo "Telegram 响应："
          echo "$response" | jq .
