name: Sync FongMi APK & Push Telegram (Stable)

on:
  schedule:
    - cron: "0 */6 * * *"   # æ¯ 6 å°æ—¶æ£€æŸ¥ä¸€æ¬¡
  workflow_dispatch:

# â­ å…³é”®ä¿®å¤ç‚¹ï¼šæ˜¾å¼ç»™ Actions å†™æƒé™ï¼ˆè§£å†³ 403ï¼‰
permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      # 0ï¸âƒ£ åŸºç¡€å·¥å…·
      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y unzip jq coreutils

      # 1ï¸âƒ£ ä¸‹è½½ fongmi åˆ†æ”¯ ZIPï¼ˆè§„é¿ raw 404 / 503ï¼‰
      - name: Download FongMi fongmi branch
        run: |
          curl -L -o fongmi.zip \
            https://codeload.github.com/FongMi/Release/zip/refs/heads/fongmi
          unzip -q fongmi.zip

      # 2ï¸âƒ£ æ”¶é›† APK
      - name: Collect APKs
        run: |
          mkdir -p apk
          find Release-fongmi/apk -type f -name "*.apk" -exec cp {} apk/ \;

          echo "Collected APKs:"
          ls -lh apk

      # 3ï¸âƒ£ è®¡ç®— APK hashï¼ˆç”¨äºé˜²é‡å¤å‘å¸ƒï¼‰
      - name: Calculate APK hash
        id: hash
        run: |
          hash=$(sha256sum apk/*.apk | sha256sum | cut -d' ' -f1)
          echo "hash=$hash" >> $GITHUB_OUTPUT
          echo "Current hash: $hash"

      # 4ï¸âƒ£ è¯»å–ä¸Šä¸€æ¬¡ hashï¼ˆå¦‚æœå­˜åœ¨ï¼‰
      - name: Load last hash
        id: last
        run: |
          if [ -f last_hash.txt ]; then
            last=$(cat last_hash.txt)
          else
            last=""
          fi
          echo "last=$last" >> $GITHUB_OUTPUT
          echo "Last hash: $last"

      # 5ï¸âƒ£ åˆ¤æ–­æ˜¯å¦æœ‰æ›´æ–°
      - name: Check for update
        id: check
        run: |
          if [ "${{ steps.hash.outputs.hash }}" = "${{ steps.last.outputs.last }}" ]; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "No APK change detected."
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "APK updated."
          fi

      # 6ï¸âƒ£ æ²¡å˜åŒ–ç›´æ¥é€€å‡º
      - name: Exit if no change
        if: steps.check.outputs.changed == 'false'
        run: exit 0

      # 7ï¸âƒ£ ä¿å­˜æœ€æ–° hash
      - name: Save new hash
        run: |
          echo "${{ steps.hash.outputs.hash }}" > last_hash.txt

      # 8ï¸âƒ£ ç”Ÿæˆ Release tag
      - name: Generate tag
        id: tag
        run: |
          tag="auto-$(date +'%Y%m%d-%H%M')"
          echo "tag=$tag" >> $GITHUB_OUTPUT

      # 9ï¸âƒ£ åˆ›å»º GitHub Releaseï¼ˆä¹‹å‰ 403 å°±å¡åœ¨è¿™é‡Œï¼‰
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          name: FongMi APK ${{ steps.tag.outputs.tag }}
          body: |
            è‡ªåŠ¨åŒæ­¥è‡ªï¼š
            https://github.com/FongMi/Release/tree/fongmi/apk

            ä»…åœ¨ APK å‘ç”Ÿå˜åŒ–æ—¶å‘å¸ƒã€‚
          files: apk/*.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ğŸ”Ÿ æ¨é€åˆ° Telegramï¼ˆURL æ–¹å¼ï¼Œä¸èµ° 50MB é™åˆ¶ï¼‰
      - name: Push to Telegram
        env:
          BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
          CHAT_ID: ${{ secrets.CHAT_ID }}
        run: |
          api="https://api.github.com/repos/${{ github.repository }}/releases/latest"
          urls=$(curl -s "$api" | jq -r '.assets[].browser_download_url')

          for url in $urls; do
            echo "Sending $url"
            curl -s -X POST "https://api.telegram.org/bot$BOT_TOKEN/sendDocument" \
              -d chat_id="$CHAT_ID" \
              -d document="$url"
            sleep 6
          done

      # 11ï¸âƒ£ æäº¤ hash æ–‡ä»¶ï¼Œä¾›ä¸‹æ¬¡å¯¹æ¯”
      - name: Commit hash
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add last_hash.txt
          git commit -m "chore: update apk hash" || echo "Nothing to commit"
          git push
