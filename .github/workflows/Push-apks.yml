name: Sync FongMi APK & Push Telegram (Stable)

on:
  schedule:
    - cron: "0 */6 * * *"   # 每6小时检查一次
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout 仓库代码
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 安装必要工具
        run: |
          sudo apt-get update
          sudo apt-get install -y unzip jq coreutils

      - name: 下载 FongMi fongmi 分支 ZIP
        run: |
          curl -L -o fongmi.zip \
            https://codeload.github.com/FongMi/Release/zip/refs/heads/fongmi
          unzip -q fongmi.zip

      - name: 收集 APK 文件
        run: |
          mkdir -p apk
          find Release-fongmi/apk -type f -name "*.apk" -exec cp {} apk/ \;
          echo "已收集的 APK："
          ls -lh apk/

      - name: 计算当前所有 APK 的 hash
        id: hash
        run: |
          if ls apk/*.apk >/dev/null 2>&1; then
            hash=$(find apk -type f -name "*.apk" -print0 | sort -z | xargs -0 sha256sum | sha256sum | cut -d' ' -f1)
          else
            hash="no-apk-$(date +%s)"
          fi
          echo "hash=$hash" >> $GITHUB_OUTPUT
          echo "当前 hash: $hash"

      - name: 读取上一次 hash
        id: last
        run: |
          last=$(cat last_hash.txt 2>/dev/null || echo "")
          echo "last=$last" >> $GITHUB_OUTPUT
          echo "上次 hash: $last"

      - name: 判断是否有更新
        id: check
        run: |
          if [ "${{ steps.hash.outputs.hash }}" = "${{ steps.last.outputs.last }}" ]; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "没有变化，退出。"
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "有更新，继续。"
          fi

      - name: 无变化则直接结束
        if: steps.check.outputs.changed == 'false'
        run: exit 0

      # ──────────────── 关键修复步骤 ────────────────
      - name: 保存新 hash 并提交到仓库（强制 cd 到仓库根目录）
        run: |
          cd "$GITHUB_WORKSPACE" || { echo "无法 cd 到 $GITHUB_WORKSPACE"; exit 1; }
          
          # 调试信息：确认当前目录和 .git 是否存在
          echo "当前工作目录：$(pwd)"
          ls -la | grep .git || echo "警告：当前目录下没有找到 .git 文件夹！"
          
          echo "${{ steps.hash.outputs.hash }}" > last_hash.txt
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add last_hash.txt
          git commit -m "chore: update last_hash for FongMi sync" || echo "hash 无变化，无需提交"
          git push origin HEAD:${{ github.ref_name }}

      - name: 生成 release tag
        id: tag
        run: |
          tag="auto-$(date +'%Y%m%d-%H%M')"
          echo "tag=$tag" >> $GITHUB_OUTPUT

      - name: 创建 GitHub Release 并上传 APK
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          name: FongMi APK ${{ steps.tag.outputs.tag }}
          body: |
            自动同步自：https://github.com/FongMi/Release/tree/fongmi/apk
            仅当 APK 内容变化时发布。
          files: apk/*.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: 推送到 Telegram
        env:
          BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
          CHAT_ID: ${{ secrets.CHAT_ID }}
        run: |
          api="https://api.github.com/repos/${{ github.repository }}/releases/latest"
          urls=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" "$api" | jq -r '.assets[].browser_download_url')

          if [ -z "$urls" ]; then
            echo "最新 release 没有找到资产"
            exit 1
          fi

          for url in $urls; do
            echo "推送至 Telegram: $url"
            curl -s -X POST "https://api.telegram.org/bot$BOT_TOKEN/sendDocument" \
              -d chat_id="$CHAT_ID" \
              -d document="$url"
            sleep 8
          done
