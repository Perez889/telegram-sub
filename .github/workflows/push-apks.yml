name: Push FongMi APKs to Telegram

on:
  workflow_dispatch:   # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  schedule:
    - cron: '0 12 * * *'  # æ¯å¤© UTC 12:00ï¼Œå¯æŒ‰éœ€ä¿®æ”¹

jobs:
  push-apks:
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ Clone ä¸»ä»“åº“
      - name: Clone FongMi/Release repository
        run: |
          git clone https://github.com/FongMi/Release.git release_temp

      # 2ï¸âƒ£ ä¸Šä¼  APK æ–‡ä»¶åˆ° Telegram
      - name: Upload APKs to Telegram
        env:
          BOT_API_URL: ${{ secrets.TELEGRAM_BOT_API_URL }}
          CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          # åˆ›å»ºä¸´æ—¶è®°å½•æ–‡ä»¶ï¼Œé¿å…é‡å¤ä¸Šä¼ 
          touch uploaded_apks.txt

          # è¿›å…¥ APK ç›®å½•
          cd release_temp/apk/release || exit 1

          for APK_FILE in *.apk; do
            # å¦‚æžœå·²ä¸Šä¼ ï¼Œåˆ™è·³è¿‡
            if grep -Fxq "$APK_FILE" ../../uploaded_apks.txt; then
              echo "$APK_FILE å·²ä¸Šä¼ ï¼Œè·³è¿‡"
              continue
            fi

            # èŽ·å– UTC æ—¶é—´
            TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M UTC")

            echo "ä¸Šä¼  $APK_FILE ..."

            # ä¸Šä¼ æ–‡ä»¶å¹¶é™„åŠ æ–‡ä»¶å + ä¸Šä¼ æ—¶é—´
            curl -X POST "$BOT_API_URL" \
                 -F "chat_id=$CHAT_ID" \
                 -F "document=@$APK_FILE" \
                 -F "caption=ðŸ“¦ æ–‡ä»¶: $APK_FILE\nðŸ•’ ä¸Šä¼ æ—¶é—´: $TIMESTAMP"

            echo "$APK_FILE ä¸Šä¼ å®Œæˆ"

            # è®°å½•å·²ä¸Šä¼ æ–‡ä»¶
            echo "$APK_FILE" >> ../../uploaded_apks.txt
          done
