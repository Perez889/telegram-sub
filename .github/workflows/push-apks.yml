name: APK to Telegram

on:
  workflow_dispatch:   # æ‰‹åŠ¨è§¦å‘
  release:
    types: [published] # å‘å¸ƒ Release æ—¶ä¹Ÿä¼šè§¦å‘

jobs:
  send-apk:
    runs-on: ubuntu-latest
    steps:
      # ç¬¬ä¸€æ­¥ï¼šæ‹‰å– FongMi Release ä»“åº“
      - name: Checkout FongMi Release repo
        uses: actions/checkout@v3
        with:
          repository: FongMi/Release

      # ç¬¬äºŒæ­¥ï¼šåˆ—å‡º APK æ–‡ä»¶
      - name: List APK files
        run: |
          echo "ä»¥ä¸‹æ˜¯ apk/release ç›®å½•é‡Œçš„ APK æ–‡ä»¶ï¼š"
          ls -lh ./apk/release/*.apk

      # ç¬¬ä¸‰æ­¥ï¼šå‘é€æç¤ºæ¶ˆæ¯åˆ° Telegram
      - name: Send release note to Telegram
        run: |
          curl -X POST \
            -F chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
            -F text="ğŸ“¢ æ–°ç‰ˆæœ¬ APK å·²åŒæ­¥åˆ°é¢‘é“ï¼" \
            ${{ secrets.TELEGRAM_BOT_API_URL }}/sendMessage

      # ç¬¬å››æ­¥ï¼šå¾ªç¯ä¸Šä¼ æ‰€æœ‰ APK æ–‡ä»¶
      - name: Upload all APKs
        run: |
          for file in ./apk/release/*.apk; do
            echo "å‡†å¤‡ä¸Šä¼ : $file"
            if [ -f "$file" ]; then
              ls -lh "$file"
              curl -v -X POST \
                -F chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
                -F document=@"$file" \
                ${{ secrets.TELEGRAM_BOT_API_URL }}/sendDocument \
                || echo "âŒ ä¸Šä¼ å¤±è´¥: $file"
            else
              echo "âŒ æ–‡ä»¶ä¸å­˜åœ¨: $file"
              exit 1
            fi
          done
