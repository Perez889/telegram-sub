name: APK to Telegram

on:
  workflow_dispatch:   # æ‰‹åŠ¨è§¦å‘
  schedule:
    - cron: '0 12 * * *'  # å¯è°ƒæ•´æ—¶é—´

jobs:
  push-apks:
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ Clone ä¸»ä»“åº“
      - name: Clone FongMi/Release repository
        run: |
          git clone https://github.com/FongMi/Release.git release_temp

      # 2ï¸âƒ£ æ¢å¤å·²ä¸Šä¼  APK åˆ—è¡¨ï¼ˆç¼“å­˜ï¼‰
      - name: Restore uploaded APK list
        id: cache
        uses: actions/cache@v3
        with:
          path: uploaded_apks.txt
          key: apk-uploaded-list
          restore-keys: apk-uploaded-list

      # 3ï¸âƒ£ ä¸Šä¼  APK åˆ° Telegram
      - name: Upload APKs to Telegram
        env:
          BOT_API_URL: ${{ secrets.TELEGRAM_BOT_API_URL }}
          CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          # ç¡®ä¿è®°å½•æ–‡ä»¶å­˜åœ¨
          touch uploaded_apks.txt

          # è¿›å…¥ APK æ‰€åœ¨ç›®å½•
          cd release_temp/apk/release || exit 1

          for APK_FILE in *.apk; do
            # å·²ä¸Šä¼ åˆ™è·³è¿‡
            if grep -Fxq "$APK_FILE" ../../uploaded_apks.txt; then
              echo "$APK_FILE å·²ä¸Šä¼ ï¼Œè·³è¿‡"
              continue
            fi

            # å½“å‰ UTC æ—¶é—´
            TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M UTC")

            echo "ä¸Šä¼  $APK_FILE ..."
            
            # ä¸Šä¼ æ–‡ä»¶ + å¸¦æ–‡ä»¶åå’Œæ—¶é—´è¯´æ˜
            curl -X POST "$BOT_API_URL" \
                 -F "chat_id=$CHAT_ID" \
                 -F "document=@$APK_FILE" \
                 -F "caption=ğŸ“¦ æ–‡ä»¶: $APK_FILE\nğŸ•’ ä¸Šä¼ æ—¶é—´: $TIMESTAMP"

            echo "$APK_FILE ä¸Šä¼ å®Œæˆ"

            # è®°å½•å·²ä¸Šä¼ 
            echo "$APK_FILE" >> ../../uploaded_apks.txt
          done

      # 4ï¸âƒ£ ä¿å­˜ä¸Šä¼ è®°å½•
      - name: Save uploaded APK list
        uses: actions/cache@v3
        with:
          path: uploaded_apks.txt
          key: apk-uploaded-list
